{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <button id="sidebar-toggle" class="sidebar-toggle-btn">‚ò∞</button>
    <div class="sidebar" id="sidebar">
        <h3>Chat Rooms</h3>
        <ul id="rooms-list">
            {% for room in rooms %}
                <li>
                    <a href="#" onclick="joinRoom({{ room.id }})">{{ room.name }}</a>
                    {% if room.creator %}
                        <small>by {{ room.creator.username }}</small>
                    {% endif %}
                    {% if room.creator_id == current_user.id %}
                        <form action="{{ url_for('delete_room', room_id=room.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this room?');">
                            <button type="submit" class="delete-room-btn">üóëÔ∏è</button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
        <div class="create-room-section">
            <h4>Create New Room</h4>
            <form id="create-room-form">
                <input type="text" id="room-name" placeholder="Room Name" required>
                <input type="text" id="room-description" placeholder="Description (optional)">
                <button type="submit" class="create-room-btn">üöÄ Create Room</button>
            </form>
        </div>
    </div>
    <div class="chat-panel">
        <div id="room-header" style="padding: 1rem; background: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(0,0,0,0.1); display: none;">
            <h2 id="room-name-display"></h2>
            <p id="room-creator-display"></p>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="emoji-btn">üòÄ</button>
            <label for="file-input" id="file-btn">üìé</label>
            <input type="file" id="file-input" accept="image/*,video/*,audio/*,application/*" style="display: none;">
            <button id="send-btn">Send</button>
        </div>
        <div id="emoji-picker" style="display: none;">
            <!-- Emoji picker will be populated by JS -->
        </div>
        <div id="image-modal" class="modal">
            <span class="close">&times;</span>
            <img class="modal-content" id="modal-img">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const roomsData = {{ rooms_data|tojson }};
</script>
<script>
    // Use functions from app.js
    document.addEventListener('DOMContentLoaded', function() {
        // Create room form
        document.getElementById('create-room-form').onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('room-name').value;
            const description = document.getElementById('room-description').value;
            fetch('/create_room', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}`
            }).then(() => location.reload());
        };

        // If no rooms, prompt to create one
        if ({{ rooms|length }} === 0) {
            alert('No rooms available. Please create a room to start chatting.');
        }

        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('sidebar-open');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && !sidebar.contains(e.target) && e.target !== sidebarToggle) {
                sidebar.classList.remove('sidebar-open');
            }
        });

        // Image modal functionality
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');
        const closeBtn = document.getElementsByClassName('close')[0];

        // Add click event to all images in messages
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG' && e.target.closest('.message')) {
                modal.style.display = "block";
                modalImg.src = e.target.src;
            }
        });

        // Close modal when clicking on close button
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        // Close modal when clicking outside the image
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        }

        // Store original joinRoom
        const originalJoinRoom = window.joinRoom;

        // Override joinRoom to update header
        window.joinRoom = function(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                document.getElementById('room-name-display').textContent = room.name;
                const creatorName = room.creator || 'Unknown';
                document.getElementById('room-creator-display').textContent = `Created by ${creatorName}`;
                document.getElementById('room-header').style.display = 'block';
            }
            // Call original joinRoom from app.js
            originalJoinRoom(roomId);
        };
    });
</script>
{% endblock %}
